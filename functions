
const fs = require('fs');
const path = require('path');

exports.handler = async function(event, context) {
  const dataPath = path.resolve(__dirname, '../keys.json');
  let file = fs.readFileSync(dataPath, 'utf8');
  let { keys, usage } = JSON.parse(file);

  if (event.httpMethod === 'GET') {
    // عداد ديناميكي للواجهة الأمامية
    let remain = keys.length * 3 - usage.reduce((a, b) => a + b, 0);
    return {
      statusCode: 200,
      body: JSON.stringify({ max: keys.length * 3, remain: remain })
    };
  }

  // POST لإنشاء الفيديو
  const { prompt } = event.body ? JSON.parse(event.body) : {};
  let selectedKey = null;
  let usedKeyIndex = -1;

  for (let i = 0; i < keys.length; i++) {
    if (usage[i] < 3) {
      selectedKey = keys[i];
      usedKeyIndex = i;
      usage[i]++;
      break;
    }
  }

  // تحديث الاستخدام فى الملف
  fs.writeFileSync(dataPath, JSON.stringify({ keys, usage }), 'utf8');

  if (!selectedKey) {
    return {
      statusCode: 429,
      body: JSON.stringify({ error: "جميع المفاتيح وصلت للحد اليومي." })
    };
  }

  // إمكان رفع صورة: ترسل كما هي وتضيفها للطلب إلى Gemini إذا كان مدعوم
  // let imageFile = ...; ← ينفذ بناءً على دعم API للصورة

  // الرد النهائي
  let remain = keys.length * 3 - usage.reduce((a, b) => a + b, 0);
  return {
    statusCode: 200,
    body: JSON.stringify({
      message: `تم استخدام مفتاح رقم (${usedKeyIndex + 1})، عدد الاستخدام اليومي له الآن هو (${usage[usedKeyIndex]}).`,
      remain: remain
    })
  };
};
