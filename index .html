<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>منصة Gemini الذكية | فيديوهات</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;400&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #38b6ff 0%, #bdf2e9 100%);
            font-family: 'Tajawal', Arial, sans-serif;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.98);
            border-radius: 24px;
            padding: 36px 26px 26px 26px;
            margin: 60px auto;
            max-width: 540px;
            box-shadow: 0 8px 24px rgba(56,182,255,0.13);
            text-align: right;
        }
        .header-nav {
            display: flex; justify-content: center;
            align-items: center; gap: 30px;
            margin-bottom: 18px;
        }
        .nav-icon {
            width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            background: #e3f9f6; border-radius: 50%;
            cursor: pointer; transition: background 0.21s;
            border: none;
        }
        .nav-icon.active { background: #38b6ff18; border: 2px solid #38b6ff; }
        .nav-icon svg { width: 22px; height: 22px; color: #2c5876; }
        h1 { font-size: 2.2em; margin-top: 0; color: #1f698b; text-align: center;}
        .input-row {
            display: flex; flex-direction: row-reverse; align-items: center;
            gap: 10px; margin-bottom: 15px; background: #f7fafd;
            border-radius: 11px; padding: 6px 8px; border: 1px solid #38b6ff;
        }
        textarea {
            flex: 1; padding: 11px 13px; border: none; border-radius: 9px;
            font-size: 1.09em; font-family: inherit; outline: none; resize: none;
            background: transparent; min-height: 43px; max-height: 170px;
            box-sizing: border-box; transition: min-height 0.18s;
        }
        .input-row input[type="file"] { display: none; }
        .img-icon-label, .add-icon-label {
            width: 35px; height: 35px; display: flex; align-items: center;
            justify-content: center; background: #e3f9f6; border-radius: 50%;
            cursor: pointer; transition: background 0.21s; margin-right: 0px;
        }
        .img-icon-label:hover, .add-icon-label:hover { background: #38b6ff18 }
        .img-icon-label svg, .add-icon-label svg, .nav-icon svg { width: 22px; height: 22px; color: #2c5876; }
        .btn {
            padding: 13px 0; width: 100%;
            background: linear-gradient(90deg,#38b6ff 40%,#1f698b 115%);
            color: #fff; font-size: 1.18em; border-radius: 9px;
            border: none; margin-top: 16px; margin-bottom: 10px;
            cursor: pointer; font-family: inherit; transition: background 0.35s;
        }
        .btn:hover { background: linear-gradient(90deg,#1f698b 0%,#38b6ff 115%);}
        #result { min-height: 34px; margin-top: 12px; font-size: 1.08em; color: #1e865c; padding: 8px 0; text-align: right;}
        .counter { font-size: 1.08em; color: #29879d; background: #e7f7f3; padding: 8px 0; margin: 16px 0 6px 0; border-radius: 7px; }
        .img-preview {
            margin-top: 8px; max-width: 100%; border-radius: 7px;
            box-shadow: 0 4px 20px #38b6ff44;
        }
        .remove-btn {
            background: none; border: none; color: #c80000; font-size: 1.2em; margin-right: 6px; cursor: pointer;
        }
        .page { display: none; }
        .page.active { display: block; }
        .videos-list {margin-top: 20px;}
        .video-card {
            background: #f7fafd; margin-bottom: 17px; border-radius: 13px; padding: 14px 14px 9px 14px;
            box-shadow: 0 2px 13px #38b6ff1a; position: relative; display: flex; flex-direction: column;
        }
        .video-preview {
            width: 100%; max-width: 330px; max-height: 185px; border-radius: 8px; margin-bottom: 10px;
            object-fit: cover; background: #fff;
        }
        .video-btns { display: flex; gap: 16px; }
        .download-btn, .delete-btn {
            padding: 4px 11px; border-radius: 6px; border: none; cursor: pointer;
            font-family: Tajawal; font-size: 1em;
        }
        .download-btn { background: #38b6ff; color: #fff; }
        .delete-btn { background: #f8c6c6; color: #aa143f; }
        .delete-all-btn {
            background: #b02a2a; color: #fff; padding: 9px 25px;
            border-radius: 7px; border: none; margin-bottom: 15px; cursor: pointer; font-family: inherit;
        }
        .delete-all-btn:hover { background: #9c1616; }
        @media (max-width: 550px) {
            .container { max-width: 99vw;}
            h1 { font-size: 1.1em;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-nav">
            <button class="nav-icon active" id="navInput">
                <!-- أيقونة إضافة (صفحة البرومبتات) -->
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M20 11H13V4a1 1 0 0 0-2 0v7H4a1 1 0 1 0 0 2h7v7a1 1 0 1 0 2 0v-7h7a1 1 0 1 0 0-2z"/></svg>
            </button>
            <button class="nav-icon" id="navGallery">
                <!-- أيقونة فيديوهات (صفحة التوليد/المعرض) -->
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 4h16v16H4V4zm2 2v12h12V6H6zm3 2h6v8H9V8z"/></svg>
            </button>
        </div>
        <h1 id="pageTitle">منصة توليد فيديوهات Gemini الذكية</h1>
        <div id="inputPage" class="page active">
            <div class="counter">
                <span id="videosCounter">إجمالي الفيديوهات المتاحة: ...</span>
            </div>
            <form id="videoForm" enctype="multipart/form-data">
                <div id="promptsList"></div>
                <button type="button" class="btn" id="addPromptBtn">أضف برومبت جديد</button>
                <button type="submit" class="btn">تنفيذ كل الفيديوهات</button>
            </form>
            <div id="result"></div>
        </div>
        <div id="galleryPage" class="page">
            <button type="button" class="delete-all-btn" id="deleteAllBtn">مسح كل الفيديوهات</button>
            <div class="videos-list" id="videosList"></div>
        </div>
    </div>
    <script>
        /* ----------- حساب العداد من السيرفر ----------- */
        async function updateCounter() {
            let res = await fetch('/.netlify/functions/generateVideo', { method: 'GET' });
            let data = await res.json();
            document.getElementById('videosCounter').innerText =
                `إجمالي الفيديوهات المتاحة: ${data.remain} من أصل ${data.max}`;
        }
        document.addEventListener("DOMContentLoaded", () => {
          updateCounter();
          addPromptRow();
          loadVideos();
        });

        /* ----------- إدارة الصفحات ----------- */
        function switchPage(inputActive) {
            document.getElementById('inputPage').classList.toggle('active', inputActive);
            document.getElementById('galleryPage').classList.toggle('active', !inputActive);
            document.getElementById('navInput').classList.toggle('active', inputActive);
            document.getElementById('navGallery').classList.toggle('active', !inputActive);
            document.getElementById('pageTitle').innerText = inputActive
                ? "منصة توليد فيديوهات Gemini الذكية"
                : "المعرض: الفيديوهات التي تم توليدها";
        }
        document.getElementById('navInput').onclick = () => switchPage(true);
        document.getElementById('navGallery').onclick = () => switchPage(false);

        /* ----------- صفوف الإدخال الديناميكية ----------- */
        function addPromptRow() {
            const rowId = `row${Date.now()}`;
            const promptsList = document.getElementById('promptsList');
            const row = document.createElement('div');
            row.className = 'input-row';
            row.id = rowId;

            row.innerHTML = `
                <label class="img-icon-label" for="image_${rowId}">
                    <input type="file" id="image_${rowId}" name="image_${rowId}" accept="image/*">
                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5C3.9 3 3 3.9 3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-2 0H5c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2zm-8-5.5c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2zm-3 2.5h6l-2.25-3L7 14.5z"/></svg>
                </label>
                <textarea id="prompt_${rowId}" name="prompt_${rowId}" rows="2" placeholder="اكتب وصف الفيديو..." required></textarea>
                <button type="button" class="remove-btn" onclick="removeRow('${rowId}')">&times;</button>
                <div class="img-preview" id="imgPreview_${rowId}"></div>
            `;
            promptsList.appendChild(row);

            // ديناميكية صندوق البرومبت
            row.querySelector(`textarea`).addEventListener('input', function() {
                this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';
            });
            // عرض معاينة الصورة
            row.querySelector(`input[type="file"]`).onchange = function(e){
                let file = e.target.files[0];
                let previewDiv = document.getElementById(`imgPreview_${rowId}`);
                if (file){
                    let reader = new FileReader();
                    reader.onload = function(evt){
                        previewDiv.innerHTML = `<img src="${evt.target.result}" class="img-preview">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewDiv.innerHTML = "";
                }
            };
        }
        function removeRow(rowId){ const row=document.getElementById(rowId); if(row)row.parentElement.removeChild(row);}
        document.getElementById('addPromptBtn').onclick = addPromptRow;

        /* ----------- تنفيذ الفيديوهات وتخزينها للمعرض ----------- */
        document.getElementById('videoForm').onsubmit = async function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('result');
            resultDiv.innerText = "جارٍ التنفيذ...";
            const rows = [...document.querySelectorAll('.input-row')];
            const batchData = [];
            for (let r of rows) {
                const prompt = r.querySelector('textarea').value.trim();
                const imgInput = r.querySelector('input[type="file"]');
                const file = imgInput.files[0];
                batchData.push({prompt, file});
            }
            let successCount = 0, errors = [];
            let videos = loadVideosFromStorage();
            for (let item of batchData) {
                let formData = new FormData();
                formData.append('prompt', item.prompt);
                if(item.file) formData.append('image', item.file);
                try {
                    let res = await fetch('/.netlify/functions/generateVideo', { method: 'POST', body: formData });
                    let data = await res.json();
                    if(data.message && data.video_url){
                        videos.push({
                            url:data.video_url,
                            prompt:item.prompt,
                            date:new Date().toLocaleString()
                        });
                        successCount++;
                    } else if(data.error) errors.push(data.error);
                } catch(err) { errors.push(err.message); }
            }
            saveVideosToStorage(videos);
            resultDiv.innerText = `تم تنفيذ ${successCount} فيديو${successCount!==1?"هات":""} بنجاح.` + (errors.length ? `\nأخطاء: ${errors.join(", ")}` : "");
            await updateCounter();
            loadVideos();
        };

        /* ----------- إدارة قائمة الفيديوهات وإجراءاتها ----------- */
        function loadVideosFromStorage(){
            let videos=localStorage.getItem('geminiVideos');
            return videos?JSON.parse(videos):[];
        }
        function saveVideosToStorage(videos){
            localStorage.setItem('geminiVideos',JSON.stringify(videos));
        }
        function loadVideos(){
            const videos=loadVideosFromStorage();
            const videosList=document.getElementById('videosList');
            videosList.innerHTML="";
            if(videos.length==0){
                videosList.innerHTML="<div style='text-align:center;color:#888;'>لا توجد فيديوهات حتى الآن</div>";
            }
            videos.forEach((v,i)=>{
                const card=document.createElement('div');
                card.className='video-card';
                card.innerHTML=`
                    <video class="video-preview" controls src="${v.url}"></video>
                    <div><strong>الوصف:</strong> ${v.prompt}</div>
                    <div><strong>التاريخ:</strong> ${v.date}</div>
                    <div class="video-btns">
                        <button class="download-btn" onclick="downloadVideo('${v.url}')">تحميل</button>
                        <button class="delete-btn" onclick="deleteVideo(${i})">مسح</button>
                    </div>
                `;
                videosList.appendChild(card);
            });
        }
        function downloadVideo(url){
            const a=document.createElement('a');
            a.href=url; a.download="gemini_video.mp4";
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function deleteVideo(i){
            let videos=loadVideosFromStorage();
            videos.splice(i,1);
            saveVideosToStorage(videos);
            loadVideos();
        }
        document.getElementById('deleteAllBtn').onclick=function(){
            if(confirm('هل أنت متأكد من مسح جميع الفيديوهات؟')){
                localStorage.removeItem('geminiVideos');
                loadVideos();
            }
        };
    </script>
</body>
</html>
